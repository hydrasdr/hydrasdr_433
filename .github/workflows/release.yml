name: Release

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # ──────────────────────────────────────────────────────────────────
  # Prepare: extract version from git describe
  # ──────────────────────────────────────────────────────────────────
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
      is_nightly: ${{ steps.version.outputs.is_nightly }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Extract version
        id: version
        run: |
          VERSION=$(git describe --tags --exclude=nightly 2>/dev/null || echo "25.12.1-g$(git rev-parse --short HEAD)")
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "is_nightly=false" >> "$GITHUB_OUTPUT"
          elif [[ "${GITHUB_REF}" == refs/heads/master && "${GITHUB_EVENT_NAME}" == "push" ]]; then
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "is_nightly=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "is_nightly=false" >> "$GITHUB_OUTPUT"
          fi
          echo "Version: ${VERSION}"

  # ──────────────────────────────────────────────────────────────────
  # Windows x64 (MSYS2 / MinGW64)
  # ──────────────────────────────────────────────────────────────────
  build-windows:
    needs: prepare
    runs-on: windows-latest
    name: Windows x64 (MinGW64)
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-libusb
            git
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Smoke test
        run: build/src/hydrasdr_433.exe -h || true
      - name: Package
        run: |
          mkdir -p dist
          cp build/src/hydrasdr_433.exe dist/
          # Copy HydraSDR shared library (built by FetchContent)
          find build -name 'libhydrasdr*.dll' -exec cp {} dist/ \; 2>/dev/null || true
          # Copy runtime DLLs
          MINGW_BIN="/mingw64/bin"
          for dll in libusb-1.0.dll libssl-3-x64.dll libcrypto-3-x64.dll; do
            [ -f "${MINGW_BIN}/${dll}" ] && cp "${MINGW_BIN}/${dll}" dist/
          done
          # Fallback: copy any libssl/libcrypto if the exact names differ
          if [ ! -f dist/libssl-3-x64.dll ]; then
            find "${MINGW_BIN}" -maxdepth 1 -name 'libssl*.dll' -exec cp {} dist/ \; 2>/dev/null || true
            find "${MINGW_BIN}" -maxdepth 1 -name 'libcrypto*.dll' -exec cp {} dist/ \; 2>/dev/null || true
          fi
          cp .deploy/WINDOWS-MINGWW64.txt dist/README.txt
          mkdir -p dist/conf
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf dist/conf/ || true
          ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-Windows-x64-v${{ needs.prepare.outputs.version }}
          path: dist/

  # ──────────────────────────────────────────────────────────────────
  # macOS builds
  # ──────────────────────────────────────────────────────────────────
  build-macos:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            arch: ARM64
          - os: macos-15-intel
            arch: x86_64
    runs-on: ${{ matrix.os }}
    name: macOS ${{ matrix.arch }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install deps
        run: brew install libusb openssl@3 ninja pkg-config
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Smoke test
        run: build/src/hydrasdr_433 -h || true
      - name: Package
        run: |
          mkdir -p dist
          cp build/src/hydrasdr_433 dist/
          find build -name 'libhydrasdr*.dylib' -exec cp {} dist/ \; 2>/dev/null || true
          mkdir -p dist/conf
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf dist/conf/ || true
          ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-macOS-${{ matrix.arch }}-v${{ needs.prepare.outputs.version }}
          path: dist/

  # ──────────────────────────────────────────────────────────────────
  # Ubuntu DEB packages (native runners)
  # ──────────────────────────────────────────────────────────────────
  build-deb:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            codename: Noble Numbat
            label: Ubuntu-24.04-LTS-Noble-Numbat
          - os: ubuntu-22.04
            codename: Jammy Jellyfish
            label: Ubuntu-22.04-LTS-Jammy-Jellyfish
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.label }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install deps
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y --no-install-recommends \
            cmake ninja-build git \
            libusb-1.0-0-dev libssl-dev
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Test
        run: |
          build/src/hydrasdr_433 -h || true
          [ -f build/external/hydrasdr-lfft/lfft_test ] && build/external/hydrasdr-lfft/lfft_test || true
          [ -f build/tests/channelizer-bench ] && build/tests/channelizer-bench || true
          [ -f build/tests/resampler-test ] && build/tests/resampler-test || true
      - name: Package DEB
        run: |
          sudo apt-get install -q -y ruby ruby-dev rubygems
          sudo gem install --no-document fpm
          VERSION=${{ needs.prepare.outputs.version }}
          # Collect files
          mkdir -p pkg/usr/bin pkg/usr/lib pkg/etc/hydrasdr_433
          cp build/src/hydrasdr_433 pkg/usr/bin/
          find build -name 'libhydrasdr.so*' -exec cp {} pkg/usr/lib/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf pkg/etc/hydrasdr_433/ || true
          fpm -s dir -t deb -n hydrasdr-433 -v "${VERSION}" -C pkg \
            -d 'libusb-1.0-0' -d 'libssl3 | libssl1.1' \
            --architecture amd64 \
            --maintainer 'HydraSDR <hydrasdr@users.noreply.github.com>' \
            --description 'RF signal decoder for HydraSDR' \
            --url 'https://github.com/hydrasdr/hydrasdr_433'
          ls -la *.deb
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-${{ matrix.label }}-v${{ needs.prepare.outputs.version }}.deb
          path: '*.deb'

  # ──────────────────────────────────────────────────────────────────
  # Debian DEB packages (containers)
  # ──────────────────────────────────────────────────────────────────
  build-debian:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: debian:trixie-slim
            label: Debian-13-Trixie
          - image: debian:bookworm-slim
            label: Debian-12-Bookworm
          - image: debian:bullseye-slim
            label: Debian-11-Bullseye
    runs-on: ubuntu-latest
    name: ${{ matrix.label }}
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install base tools
        run: |
          apt-get update -q -y
          apt-get install -q -y --no-install-recommends \
            git ca-certificates cmake ninja-build \
            gcc g++ make pkg-config \
            libusb-1.0-0-dev libssl-dev \
            ruby ruby-dev rubygems
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fix git ownership
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Test
        run: |
          build/src/hydrasdr_433 -h || true
          [ -f build/external/hydrasdr-lfft/lfft_test ] && build/external/hydrasdr-lfft/lfft_test || true
          [ -f build/tests/channelizer-bench ] && build/tests/channelizer-bench || true
      - name: Package DEB
        run: |
          gem install --no-document --bindir /usr/bin erb fpm
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p pkg/usr/bin pkg/usr/lib pkg/etc/hydrasdr_433
          cp build/src/hydrasdr_433 pkg/usr/bin/
          find build -name 'libhydrasdr.so*' -exec cp {} pkg/usr/lib/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf pkg/etc/hydrasdr_433/ || true
          fpm -s dir -t deb -n hydrasdr-433 -v "${VERSION}" -C pkg \
            -d 'libusb-1.0-0' -d 'libssl3 | libssl1.1' \
            --architecture amd64 \
            --maintainer 'HydraSDR <hydrasdr@users.noreply.github.com>' \
            --description 'RF signal decoder for HydraSDR' \
            --url 'https://github.com/hydrasdr/hydrasdr_433'
          ls -la *.deb
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-${{ matrix.label }}-v${{ needs.prepare.outputs.version }}.deb
          path: '*.deb'

  # ──────────────────────────────────────────────────────────────────
  # Linux Mint DEB packages
  # ──────────────────────────────────────────────────────────────────
  build-mint:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            label: Mint-22.1-Xia
          - os: ubuntu-24.04
            label: Mint-22-Wilma
          - os: ubuntu-22.04
            label: Mint-21.3-Virginia
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.label }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install deps
        run: |
          sudo apt-get update -q -y
          sudo apt-get install -q -y --no-install-recommends \
            cmake ninja-build git \
            libusb-1.0-0-dev libssl-dev \
            ruby ruby-dev rubygems
          sudo gem install --no-document fpm
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Test
        run: |
          build/src/hydrasdr_433 -h || true
      - name: Package DEB
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p pkg/usr/bin pkg/usr/lib pkg/etc/hydrasdr_433
          cp build/src/hydrasdr_433 pkg/usr/bin/
          find build -name 'libhydrasdr.so*' -exec cp {} pkg/usr/lib/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf pkg/etc/hydrasdr_433/ || true
          fpm -s dir -t deb -n hydrasdr-433 -v "${VERSION}" -C pkg \
            -d 'libusb-1.0-0' -d 'libssl3 | libssl1.1' \
            --architecture amd64 \
            --maintainer 'HydraSDR <hydrasdr@users.noreply.github.com>' \
            --description 'RF signal decoder for HydraSDR' \
            --url 'https://github.com/hydrasdr/hydrasdr_433'
          ls -la *.deb
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-${{ matrix.label }}-v${{ needs.prepare.outputs.version }}.deb
          path: '*.deb'

  # ──────────────────────────────────────────────────────────────────
  # Fedora RPM packages (containers)
  # ──────────────────────────────────────────────────────────────────
  build-fedora:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: fedora:42
            label: Fedora-42
          - image: fedora:41
            label: Fedora-41
    runs-on: ubuntu-latest
    name: ${{ matrix.label }}
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install deps
        run: |
          dnf -y update
          dnf -y install \
            git cmake ninja-build gcc gcc-c++ make pkg-config \
            libusb1-devel openssl-devel \
            ruby ruby-devel rubygems rpm-build
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fix git ownership
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Test
        run: |
          build/src/hydrasdr_433 -h || true
          [ -f build/external/hydrasdr-lfft/lfft_test ] && build/external/hydrasdr-lfft/lfft_test || true
          [ -f build/tests/channelizer-bench ] && build/tests/channelizer-bench || true
      - name: Package RPM
        run: |
          gem install --no-document --bindir /usr/bin erb fpm
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p pkg/usr/bin pkg/usr/lib64 pkg/etc/hydrasdr_433
          cp build/src/hydrasdr_433 pkg/usr/bin/
          find build -name 'libhydrasdr.so*' -exec cp {} pkg/usr/lib64/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf pkg/etc/hydrasdr_433/ || true
          fpm -s dir -t rpm -n hydrasdr-433 -v "${VERSION}" -C pkg \
            -d 'libusb1' -d 'openssl-libs' \
            --architecture x86_64 \
            --maintainer 'HydraSDR <hydrasdr@users.noreply.github.com>' \
            --description 'RF signal decoder for HydraSDR' \
            --url 'https://github.com/hydrasdr/hydrasdr_433'
          ls -la *.rpm
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-${{ matrix.label }}-v${{ needs.prepare.outputs.version }}.rpm
          path: '*.rpm'

  # ──────────────────────────────────────────────────────────────────
  # AlmaLinux RPM package (container)
  # ──────────────────────────────────────────────────────────────────
  build-almalinux:
    needs: prepare
    runs-on: ubuntu-latest
    name: AlmaLinux 9
    container:
      image: almalinux:9
    steps:
      - name: Install deps
        run: |
          dnf -y update
          dnf -y install epel-release
          /usr/bin/crb enable
          dnf -y install \
            git cmake ninja-build gcc gcc-c++ make pkg-config \
            libusbx-devel openssl-devel \
            ruby ruby-devel rubygems rpm-build
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fix git ownership
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Test
        run: |
          build/src/hydrasdr_433 -h || true
      - name: Package RPM
        run: |
          gem install --no-document --bindir /usr/bin erb fpm
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p pkg/usr/bin pkg/usr/lib64 pkg/etc/hydrasdr_433
          cp build/src/hydrasdr_433 pkg/usr/bin/
          find build -name 'libhydrasdr.so*' -exec cp {} pkg/usr/lib64/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf pkg/etc/hydrasdr_433/ || true
          fpm -s dir -t rpm -n hydrasdr-433 -v "${VERSION}" -C pkg \
            -d 'libusbx' -d 'openssl-libs' \
            --architecture x86_64 \
            --maintainer 'HydraSDR <hydrasdr@users.noreply.github.com>' \
            --description 'RF signal decoder for HydraSDR' \
            --url 'https://github.com/hydrasdr/hydrasdr_433'
          ls -la *.rpm
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-AlmaLinux-9-v${{ needs.prepare.outputs.version }}.rpm
          path: '*.rpm'

  # ──────────────────────────────────────────────────────────────────
  # openSUSE Tumbleweed RPM package (container)
  # ──────────────────────────────────────────────────────────────────
  build-opensuse:
    needs: prepare
    runs-on: ubuntu-latest
    name: openSUSE Tumbleweed
    container:
      image: opensuse/tumbleweed
    steps:
      - name: Install deps
        run: |
          zypper -n refresh
          zypper -n install \
            git cmake ninja gcc gcc-c++ make pkg-config \
            libusb-1_0-devel libopenssl-devel \
            ruby ruby-devel rpm-build
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fix git ownership
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Test
        run: |
          build/src/hydrasdr_433 -h || true
      - name: Package RPM
        run: |
          gem install --no-document --bindir /usr/bin erb fpm
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p pkg/usr/bin pkg/usr/lib64 pkg/etc/hydrasdr_433
          cp build/src/hydrasdr_433 pkg/usr/bin/
          find build -name 'libhydrasdr.so*' -exec cp {} pkg/usr/lib64/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf pkg/etc/hydrasdr_433/ || true
          fpm -s dir -t rpm -n hydrasdr-433 -v "${VERSION}" -C pkg \
            -d 'libusb-1_0-0' -d 'libopenssl1_1' \
            --architecture x86_64 \
            --maintainer 'HydraSDR <hydrasdr@users.noreply.github.com>' \
            --description 'RF signal decoder for HydraSDR' \
            --url 'https://github.com/hydrasdr/hydrasdr_433'
          ls -la *.rpm
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-openSUSE-Tumbleweed-v${{ needs.prepare.outputs.version }}.rpm
          path: '*.rpm'

  # ──────────────────────────────────────────────────────────────────
  # Arch Linux pkg.tar.zst package (container)
  # ──────────────────────────────────────────────────────────────────
  build-archlinux:
    needs: prepare
    runs-on: ubuntu-latest
    name: Arch Linux
    container:
      image: archlinux:latest
    steps:
      - name: Install deps
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            git cmake ninja gcc make pkg-config \
            libusb openssl \
            ruby
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fix git ownership
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Configure
        run: cmake -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Test
        run: |
          build/src/hydrasdr_433 -h || true
      - name: Package pkg.tar.zst
        run: |
          gem install --no-document --bindir /usr/local/bin erb fpm
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p pkg/usr/bin pkg/usr/lib pkg/etc/hydrasdr_433
          cp build/src/hydrasdr_433 pkg/usr/bin/
          find build -name 'libhydrasdr.so*' -exec cp {} pkg/usr/lib/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf pkg/etc/hydrasdr_433/ || true
          fpm -s dir -t pacman -n hydrasdr-433 -v "${VERSION}" -C pkg \
            -d 'libusb' -d 'openssl' \
            --architecture x86_64 \
            --maintainer 'HydraSDR <hydrasdr@users.noreply.github.com>' \
            --description 'RF signal decoder for HydraSDR' \
            --url 'https://github.com/hydrasdr/hydrasdr_433'
          ls -la *.pkg.tar.zst || ls -la *.pkg.tar* || true
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-Arch-Linux-v${{ needs.prepare.outputs.version }}.pkg.tar.zst
          path: '*.pkg.tar*'

  # ──────────────────────────────────────────────────────────────────
  # ARM64 cross-compile (tar.gz)
  # ──────────────────────────────────────────────────────────────────
  build-arm64:
    needs: prepare
    runs-on: ubuntu-22.04
    name: Linux ARM64 (cross-compile)
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install cross toolchain and deps
        run: |
          sudo dpkg --add-architecture arm64
          # Add arm64 sources
          sudo sed -i 's/^deb /deb [arch=amd64,i386] /' /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ jammy main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
          sudo apt-get update -q -y
          sudo apt-get install -q -y --no-install-recommends \
            cmake ninja-build git \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libusb-1.0-0-dev:arm64 libssl-dev:arm64
      - name: Configure
        env:
          PKG_CONFIG_LIBDIR: /usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
        run: |
          cmake \
            -DCMAKE_TOOLCHAIN_FILE="${PWD}/cmake/Toolchain-aarch64-linux-gnu.cmake" \
            -GNinja -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      - name: Build
        run: cmake --build build
      - name: Check binary
        run: |
          file build/src/hydrasdr_433
          aarch64-linux-gnu-readelf -a build/src/hydrasdr_433 | grep "Shared library:" || true
      - name: Package
        run: |
          mkdir -p dist/conf
          cp build/src/hydrasdr_433 dist/
          find build -name 'libhydrasdr.so*' -exec cp {} dist/ \; 2>/dev/null || true
          [ -f conf/hydrasdr_433.example.conf ] && cp conf/hydrasdr_433.example.conf dist/conf/ || true
          ls -la dist/
      - uses: actions/upload-artifact@v4
        with:
          name: hydrasdr_433-Linux-ARM64-v${{ needs.prepare.outputs.version }}
          path: dist/

  # ──────────────────────────────────────────────────────────────────
  # Create Nightly Pre-Release (push to master)
  # ──────────────────────────────────────────────────────────────────
  create-nightly:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs:
      - prepare
      - build-windows
      - build-macos
      - build-deb
      - build-debian
      - build-mint
      - build-fedora
      - build-almalinux
      - build-opensuse
      - build-archlinux
      - build-arm64
    runs-on: ubuntu-latest
    name: Create Nightly Release
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create archives
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p release

          # Windows → zip
          if [ -d "artifacts/hydrasdr_433-Windows-x64-v${VERSION}" ]; then
            cd "artifacts/hydrasdr_433-Windows-x64-v${VERSION}"
            zip -r "../../release/hydrasdr_433-Windows-x64-v${VERSION}.zip" .
            cd ../..
          fi

          # macOS → tar.gz
          for arch in ARM64 x86_64; do
            dir="artifacts/hydrasdr_433-macOS-${arch}-v${VERSION}"
            if [ -d "$dir" ]; then
              tar czf "release/hydrasdr_433-macOS-${arch}-v${VERSION}.tar.gz" -C "$dir" .
            fi
          done

          # ARM64 → tar.gz
          dir="artifacts/hydrasdr_433-Linux-ARM64-v${VERSION}"
          if [ -d "$dir" ]; then
            tar czf "release/hydrasdr_433-Linux-ARM64-v${VERSION}.tar.gz" -C "$dir" .
          fi

          # DEBs — copy from artifact dirs
          find artifacts -name '*.deb' -exec cp {} release/ \;

          # RPMs — copy from artifact dirs
          find artifacts -name '*.rpm' -exec cp {} release/ \;

          # Arch — copy from artifact dirs
          find artifacts -name '*.pkg.tar*' -exec cp {} release/ \;

          echo "=== Release artifacts ==="
          ls -la release/

      - name: Generate nightly release notes
        run: |
          cat > RELEASEINFO.md <<'NOTES_EOF'
          ## Nightly Build

          **Automated build from `master` branch.**

          Built from commit: ${{ github.sha }}
          Version: ${{ needs.prepare.outputs.version }}

          ### Platforms

          | Platform | File |
          |----------|------|
          | Windows x64 | `hydrasdr_433-Windows-x64-*.zip` |
          | macOS ARM64 (Apple Silicon) | `hydrasdr_433-macOS-ARM64-*.tar.gz` |
          | macOS x86_64 (Intel) | `hydrasdr_433-macOS-x86_64-*.tar.gz` |
          | Ubuntu 24.04 / 22.04 | `.deb` packages |
          | Debian 13 / 12 / 11 | `.deb` packages |
          | Linux Mint 22.1 / 22 / 21.3 | `.deb` packages |
          | Fedora 42 / 41 | `.rpm` packages |
          | AlmaLinux 9 | `.rpm` package |
          | openSUSE Tumbleweed | `.rpm` package |
          | Arch Linux | `.pkg.tar.zst` package |
          | Linux ARM64 | `hydrasdr_433-Linux-ARM64-*.tar.gz` |

          ### Install

          **Windows:** Extract zip, run `hydrasdr_433.exe` from terminal.
          **macOS:** Extract tar.gz, run `./hydrasdr_433`.
          **Debian/Ubuntu/Mint:** `sudo dpkg -i hydrasdr-433_*.deb && sudo apt-get install -f`
          **Fedora/AlmaLinux/openSUSE:** `sudo rpm -i hydrasdr-433-*.rpm`
          **Arch Linux:** `sudo pacman -U hydrasdr-433-*.pkg.tar.zst`
          **ARM64:** Extract tar.gz, run `./hydrasdr_433`.

          ### Requirements
          - HydraSDR hardware + libusb
          - Optional: OpenSSL for TLS (MQTT/InfluxDB)
          NOTES_EOF

      - name: Delete existing nightly release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete nightly --yes --cleanup-tag 2>/dev/null || true

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create nightly \
            --title "Nightly Build (${{ needs.prepare.outputs.version }})" \
            --notes-file RELEASEINFO.md \
            --prerelease \
            --target "${{ github.sha }}" \
            release/*

  # ──────────────────────────────────────────────────────────────────
  # Create Tagged Release (push tag v*)
  # ──────────────────────────────────────────────────────────────────
  create-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - prepare
      - build-windows
      - build-macos
      - build-deb
      - build-debian
      - build-mint
      - build-fedora
      - build-almalinux
      - build-opensuse
      - build-archlinux
      - build-arm64
    runs-on: ubuntu-latest
    name: Create Release
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create archives
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          mkdir -p release

          # Windows → zip
          if [ -d "artifacts/hydrasdr_433-Windows-x64-v${VERSION}" ]; then
            cd "artifacts/hydrasdr_433-Windows-x64-v${VERSION}"
            zip -r "../../release/hydrasdr_433-Windows-x64-v${VERSION}.zip" .
            cd ../..
          fi

          # macOS → tar.gz
          for arch in ARM64 x86_64; do
            dir="artifacts/hydrasdr_433-macOS-${arch}-v${VERSION}"
            if [ -d "$dir" ]; then
              tar czf "release/hydrasdr_433-macOS-${arch}-v${VERSION}.tar.gz" -C "$dir" .
            fi
          done

          # ARM64 → tar.gz
          dir="artifacts/hydrasdr_433-Linux-ARM64-v${VERSION}"
          if [ -d "$dir" ]; then
            tar czf "release/hydrasdr_433-Linux-ARM64-v${VERSION}.tar.gz" -C "$dir" .
          fi

          # DEBs
          find artifacts -name '*.deb' -exec cp {} release/ \;

          # RPMs
          find artifacts -name '*.rpm' -exec cp {} release/ \;

          # Arch
          find artifacts -name '*.pkg.tar*' -exec cp {} release/ \;

          echo "=== Release artifacts ==="
          ls -la release/

      - name: Generate release notes
        run: ./.deploy/gen_release_info.py

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "Release ${{ github.ref_name }}" \
            --notes-file RELEASEINFO.md \
            --target "${{ github.sha }}" \
            release/*
